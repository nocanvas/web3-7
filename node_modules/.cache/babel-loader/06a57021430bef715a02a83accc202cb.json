{"ast":null,"code":"var _regeneratorRuntime = require(\"/Users/john/Documents/GitHub/test1/client/node_modules/@babel/runtime/regenerator\");\n\nvar _asyncToGenerator = require(\"/Users/john/Documents/GitHub/test1/client/node_modules/@babel/runtime/helpers/asyncToGenerator\");\n\nvar _objectSpread = require(\"/Users/john/Documents/GitHub/test1/client/node_modules/@babel/runtime/helpers/objectSpread2\");\n\nvar _toConsumableArray = require(\"/Users/john/Documents/GitHub/test1/client/node_modules/@babel/runtime/helpers/toConsumableArray\");\n\nvar ethUtils = require('ethereumjs-util');\n\nvar BN = require('bignumber.js');\n\nvar _require = require('web3-utils'),\n    toBN = _require.toBN,\n    soliditySha3 = _require.soliditySha3;\n\nvar relayHubAbi = require('./tabookey-gasless/IRelayHub');\n\nvar relayRecipientAbi = require('./tabookey-gasless/IRelayRecipient');\n\nvar abiDecoder = require('abi-decoder');\n\nabiDecoder.addABI(relayHubAbi);\n\nfunction appendAddress(data, address) {\n  return data + ethUtils.setLengthLeft(ethUtils.toBuffer(address), 32).toString('hex');\n}\n\nfunction callAsJsonRpc(fn, args, id, callback) {\n  var mapResponseFn = arguments.length > 4 && arguments[4] !== undefined ? arguments[4] : function (x) {\n    return {\n      result: x\n    };\n  };\n  var response = {\n    jsonrpc: '2.0',\n    id: id\n  };\n\n  try {\n    fn.apply(void 0, _toConsumableArray(args)).then(function (result) {\n      callback(null, _objectSpread(_objectSpread({}, response), mapResponseFn(result)));\n    }).catch(function (err) {\n      callback(_objectSpread(_objectSpread({}, response), {}, {\n        error: err.toString()\n      }), null);\n    });\n  } catch (err) {\n    callback(_objectSpread(_objectSpread({}, response), {}, {\n      error: err.toString()\n    }));\n  }\n}\n\nfunction toInt(value) {\n  return new BN(value).toNumber();\n}\n\nfunction preconditionCodeToDescription(code) {\n  switch (parseInt(code)) {\n    case 1:\n      return 'wrong signature';\n\n    case 2:\n      return 'wrong nonce';\n\n    case 3:\n      return 'recipient reverted in acceptRelayedCall';\n\n    case 4:\n      return 'invalid status code returned by the recipient';\n\n    default:\n      return \"error \".concat(code);\n  }\n}\n\nfunction fixTransactionReceiptResponse(resp) {\n  var debug = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;\n  if (!resp || !resp.result || !resp.result.logs) return resp;\n  var logs = abiDecoder.decodeLogs(resp.result.logs);\n  var canRelayFailed = logs.find(function (e) {\n    return e && e.name == 'CanRelayFailed';\n  });\n  var transactionRelayed = logs.find(function (e) {\n    return e && e.name == 'TransactionRelayed';\n  });\n\n  var setErrorStatus = function setErrorStatus(reason) {\n    if (debug) console.log(\"Setting tx receipt status to zero while fetching tx receipt (\".concat(reason, \")\"));\n    resp.result.status = 0;\n  };\n\n  if (canRelayFailed) {\n    setErrorStatus(\"canRelay failed with \".concat(canRelayFailed.events.find(function (e) {\n      return e.name == 'reason';\n    }).value));\n  } else if (transactionRelayed) {\n    var status = transactionRelayed.events.find(function (e) {\n      return e.name == 'status';\n    }).value;\n\n    if (parseInt(status) !== 0) {\n      // 0 signifies success\n      setErrorStatus(\"reverted relayed transaction with status code \".concat(status));\n    }\n  }\n\n  return resp;\n}\n\nfunction getApprovalData(_x, _x2) {\n  return _getApprovalData.apply(this, arguments);\n}\n\nfunction _getApprovalData() {\n  _getApprovalData = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2(approveFunction, options) {\n    return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n      while (1) {\n        switch (_context2.prev = _context2.next) {\n          case 0:\n            _context2.prev = 0;\n\n            if (!(typeof approveFunction === 'function')) {\n              _context2.next = 7;\n              break;\n            }\n\n            _context2.next = 4;\n            return approveFunction(options);\n\n          case 4:\n            return _context2.abrupt(\"return\", _context2.sent);\n\n          case 7:\n            return _context2.abrupt(\"return\", '0x');\n\n          case 8:\n            _context2.next = 13;\n            break;\n\n          case 10:\n            _context2.prev = 10;\n            _context2.t0 = _context2[\"catch\"](0);\n            throw new Error(\"Error running approveFunction for transaction: \".concat(_context2.t0.message || _context2.t0));\n\n          case 13:\n          case \"end\":\n            return _context2.stop();\n        }\n      }\n    }, _callee2, null, [[0, 10]]);\n  }));\n  return _getApprovalData.apply(this, arguments);\n}\n\nfunction fixSignature(signature) {\n  // in geth its always 27/28, in ganache its 0/1. Change to 27/28 to prevent\n  // signature malleability if version is 0/1\n  // see https://github.com/ethereum/go-ethereum/blob/v1.8.23/internal/ethapi/api.go#L465\n  var v = parseInt(signature.slice(130, 132), 16);\n\n  if (v < 27) {\n    v += 27;\n  }\n\n  var vHex = v.toString(16);\n  return signature.slice(0, 130) + vHex;\n}\n\nfunction makeApproveFunction(signFn, verbose) {\n  return /*#__PURE__*/function () {\n    var _ref = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee(data) {\n      var signature;\n      return _regeneratorRuntime.wrap(function _callee$(_context) {\n        while (1) {\n          switch (_context.prev = _context.next) {\n            case 0:\n              _context.t0 = fixSignature;\n              _context.next = 3;\n              return signFn(soliditySha3({\n                type: 'address',\n                value: data.relayerAddress\n              }, {\n                type: 'address',\n                value: data.from\n              }, {\n                type: 'bytes',\n                value: data.encodedFunctionCall\n              }, {\n                type: 'uint256',\n                value: toBN(data.txFee)\n              }, {\n                type: 'uint256',\n                value: toBN(data.gasPrice)\n              }, {\n                type: 'uint256',\n                value: toBN(data.gas)\n              }, {\n                type: 'uint256',\n                value: toBN(data.nonce)\n              }, {\n                type: 'address',\n                value: data.relayHubAddress\n              }, {\n                type: 'address',\n                value: data.to\n              }));\n\n            case 3:\n              _context.t1 = _context.sent;\n              signature = (0, _context.t0)(_context.t1);\n              if (verbose) console.log(\"Signature for GSN transaction is \".concat(signature));\n              return _context.abrupt(\"return\", signature);\n\n            case 7:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n      }, _callee);\n    }));\n\n    return function (_x3) {\n      return _ref.apply(this, arguments);\n    };\n  }();\n}\n\nfunction createRelayHubFromRecipient(_x4, _x5) {\n  return _createRelayHubFromRecipient.apply(this, arguments);\n}\n\nfunction _createRelayHubFromRecipient() {\n  _createRelayHubFromRecipient = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee3(web3, recipientAddress) {\n    var relayRecipient, relayHubAddress, code, relayHub, hubVersion;\n    return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n      while (1) {\n        switch (_context3.prev = _context3.next) {\n          case 0:\n            relayRecipient = createRelayRecipient(web3, recipientAddress);\n            _context3.prev = 1;\n            _context3.next = 4;\n            return relayRecipient.methods.getHubAddr().call();\n\n          case 4:\n            relayHubAddress = _context3.sent;\n            _context3.next = 10;\n            break;\n\n          case 7:\n            _context3.prev = 7;\n            _context3.t0 = _context3[\"catch\"](1);\n            throw new Error(\"Could not get relay hub address from recipient at \".concat(recipientAddress, \" (\").concat(_context3.t0.message, \"). Make sure it is a valid recipient contract.\"));\n\n          case 10:\n            if (!(!relayHubAddress || ethUtils.isZeroAddress(relayHubAddress))) {\n              _context3.next = 12;\n              break;\n            }\n\n            throw new Error(\"The relay hub address is set to zero in recipient at \".concat(recipientAddress, \". Make sure it is a valid recipient contract.\"));\n\n          case 12:\n            _context3.next = 14;\n            return web3.eth.getCode(relayHubAddress);\n\n          case 14:\n            code = _context3.sent;\n\n            if (!(code.length <= 2)) {\n              _context3.next = 17;\n              break;\n            }\n\n            throw new Error(\"Relay hub is not deployed at address \".concat(relayHubAddress));\n\n          case 17:\n            relayHub = createRelayHub(web3, relayHubAddress);\n            _context3.prev = 18;\n            _context3.next = 21;\n            return relayHub.methods.version().call();\n\n          case 21:\n            hubVersion = _context3.sent;\n            _context3.next = 27;\n            break;\n\n          case 24:\n            _context3.prev = 24;\n            _context3.t1 = _context3[\"catch\"](18);\n            throw new Error(\"Could not query relay hub version at \".concat(relayHubAddress, \" (\").concat(_context3.t1.message, \"). Make sure the address corresponds to a relay hub.\"));\n\n          case 27:\n            if (hubVersion.startsWith('1')) {\n              _context3.next = 29;\n              break;\n            }\n\n            throw new Error(\"Unsupported relay hub version '\".concat(hubVersion, \"'.\"));\n\n          case 29:\n            return _context3.abrupt(\"return\", relayHub);\n\n          case 30:\n          case \"end\":\n            return _context3.stop();\n        }\n      }\n    }, _callee3, null, [[1, 7], [18, 24]]);\n  }));\n  return _createRelayHubFromRecipient.apply(this, arguments);\n}\n\nfunction createRelayRecipient(web3, addr) {\n  return new web3.eth.Contract(relayRecipientAbi, addr);\n}\n\nfunction createRelayHub(web3, addr) {\n  return new web3.eth.Contract(relayHubAbi, addr);\n}\n\nfunction isRelayHubDeployedForRecipient(_x6, _x7) {\n  return _isRelayHubDeployedForRecipient.apply(this, arguments);\n}\n\nfunction _isRelayHubDeployedForRecipient() {\n  _isRelayHubDeployedForRecipient = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee4(web3, recipientAddr) {\n    return _regeneratorRuntime.wrap(function _callee4$(_context4) {\n      while (1) {\n        switch (_context4.prev = _context4.next) {\n          case 0:\n            _context4.prev = 0;\n            _context4.next = 3;\n            return createRelayHubFromRecipient(web3, recipientAddr);\n\n          case 3:\n            return _context4.abrupt(\"return\", true);\n\n          case 6:\n            _context4.prev = 6;\n            _context4.t0 = _context4[\"catch\"](0);\n            return _context4.abrupt(\"return\", false);\n\n          case 9:\n          case \"end\":\n            return _context4.stop();\n        }\n      }\n    }, _callee4, null, [[0, 6]]);\n  }));\n  return _isRelayHubDeployedForRecipient.apply(this, arguments);\n}\n\nfunction getRecipientFunds(_x8, _x9) {\n  return _getRecipientFunds.apply(this, arguments);\n} // Gtxdatazero 4 Paid for every zero byte of data or code for a transaction.\n// Gtxdatanonzero 68 Paid for every non-zero byte of data or code for a transaction\n// From yellow paper https://gavwood.com/paper.pdf\n// May change soon (EIP 2028: Transaction data gas cost reduction) https://eips.ethereum.org/EIPS/eip-2028\n\n\nfunction _getRecipientFunds() {\n  _getRecipientFunds = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee5(web3, recipientAddr) {\n    var relayHub;\n    return _regeneratorRuntime.wrap(function _callee5$(_context5) {\n      while (1) {\n        switch (_context5.prev = _context5.next) {\n          case 0:\n            _context5.next = 2;\n            return createRelayHubFromRecipient(web3, recipientAddr);\n\n          case 2:\n            relayHub = _context5.sent;\n            _context5.next = 5;\n            return relayHub.methods.balanceOf(recipientAddr).call();\n\n          case 5:\n            return _context5.abrupt(\"return\", _context5.sent);\n\n          case 6:\n          case \"end\":\n            return _context5.stop();\n        }\n      }\n    }, _callee5);\n  }));\n  return _getRecipientFunds.apply(this, arguments);\n}\n\nfunction getCallDataGas(data) {\n  if (typeof data !== 'string') throw new Error('Data has to be a string');\n  if (data.startsWith('0x')) data = data.slice(2);\n  var gasCost = 0;\n\n  for (var i = 0; i < data.length; i += 2) {\n    if (data.substr(i, 2) === '00') {\n      gasCost += 4;\n    } else {\n      gasCost += 68;\n    }\n  }\n\n  return gasCost;\n}\n\nmodule.exports = {\n  appendAddress: appendAddress,\n  callAsJsonRpc: callAsJsonRpc,\n  toInt: toInt,\n  preconditionCodeToDescription: preconditionCodeToDescription,\n  fixTransactionReceiptResponse: fixTransactionReceiptResponse,\n  getApprovalData: getApprovalData,\n  fixSignature: fixSignature,\n  makeApproveFunction: makeApproveFunction,\n  createRelayHubFromRecipient: createRelayHubFromRecipient,\n  isRelayHubDeployedForRecipient: isRelayHubDeployedForRecipient,\n  getRecipientFunds: getRecipientFunds,\n  getCallDataGas: getCallDataGas,\n  createRelayHub: createRelayHub\n};","map":{"version":3,"sources":["/Users/john/Documents/GitHub/test1/node_modules/@openzeppelin/gsn-provider/src/utils.js"],"names":["ethUtils","require","BN","toBN","soliditySha3","relayHubAbi","relayRecipientAbi","abiDecoder","addABI","appendAddress","data","address","setLengthLeft","toBuffer","toString","callAsJsonRpc","fn","args","id","callback","mapResponseFn","x","result","response","jsonrpc","then","catch","err","error","toInt","value","toNumber","preconditionCodeToDescription","code","parseInt","fixTransactionReceiptResponse","resp","debug","logs","decodeLogs","canRelayFailed","find","e","name","transactionRelayed","setErrorStatus","reason","console","log","status","events","getApprovalData","approveFunction","options","Error","message","fixSignature","signature","v","slice","vHex","makeApproveFunction","signFn","verbose","type","relayerAddress","from","encodedFunctionCall","txFee","gasPrice","gas","nonce","relayHubAddress","to","createRelayHubFromRecipient","web3","recipientAddress","relayRecipient","createRelayRecipient","methods","getHubAddr","call","isZeroAddress","eth","getCode","length","relayHub","createRelayHub","version","hubVersion","startsWith","addr","Contract","isRelayHubDeployedForRecipient","recipientAddr","getRecipientFunds","balanceOf","getCallDataGas","gasCost","i","substr","module","exports"],"mappings":"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","sourcesContent":["const ethUtils = require('ethereumjs-util');\nconst BN = require('bignumber.js');\nconst { toBN, soliditySha3 } = require('web3-utils');\n\nconst relayHubAbi = require('./tabookey-gasless/IRelayHub');\nconst relayRecipientAbi = require('./tabookey-gasless/IRelayRecipient');\n\nconst abiDecoder = require('abi-decoder');\nabiDecoder.addABI(relayHubAbi);\n\nfunction appendAddress(data, address) {\n  return data + ethUtils.setLengthLeft(ethUtils.toBuffer(address), 32).toString('hex');\n}\n\nfunction callAsJsonRpc(fn, args, id, callback, mapResponseFn = x => ({ result: x })) {\n  const response = { jsonrpc: '2.0', id };\n  try {\n    fn(...args)\n      .then(result => {\n        callback(null, { ...response, ...mapResponseFn(result) });\n      })\n      .catch(err => {\n        callback({ ...response, error: err.toString() }, null);\n      });\n  } catch (err) {\n    callback({ ...response, error: err.toString() });\n  }\n}\n\nfunction toInt(value) {\n  return new BN(value).toNumber();\n}\n\nfunction preconditionCodeToDescription(code) {\n  switch (parseInt(code)) {\n    case 1:\n      return 'wrong signature';\n    case 2:\n      return 'wrong nonce';\n    case 3:\n      return 'recipient reverted in acceptRelayedCall';\n    case 4:\n      return 'invalid status code returned by the recipient';\n    default:\n      return `error ${code}`;\n  }\n}\n\nfunction fixTransactionReceiptResponse(resp, debug = false) {\n  if (!resp || !resp.result || !resp.result.logs) return resp;\n\n  const logs = abiDecoder.decodeLogs(resp.result.logs);\n  const canRelayFailed = logs.find(e => e && e.name == 'CanRelayFailed');\n  const transactionRelayed = logs.find(e => e && e.name == 'TransactionRelayed');\n\n  const setErrorStatus = reason => {\n    if (debug) console.log(`Setting tx receipt status to zero while fetching tx receipt (${reason})`);\n    resp.result.status = 0;\n  };\n\n  if (canRelayFailed) {\n    setErrorStatus(`canRelay failed with ${canRelayFailed.events.find(e => e.name == 'reason').value}`);\n  } else if (transactionRelayed) {\n    const status = transactionRelayed.events.find(e => e.name == 'status').value;\n    if (parseInt(status) !== 0) {\n      // 0 signifies success\n      setErrorStatus(`reverted relayed transaction with status code ${status}`);\n    }\n  }\n\n  return resp;\n}\n\nasync function getApprovalData(approveFunction, options) {\n  try {\n    if (typeof approveFunction === 'function') {\n      return await approveFunction(options);\n    } else {\n      return '0x';\n    }\n  } catch (err) {\n    throw new Error(`Error running approveFunction for transaction: ${err.message || err}`);\n  }\n}\n\nfunction fixSignature(signature) {\n  // in geth its always 27/28, in ganache its 0/1. Change to 27/28 to prevent\n  // signature malleability if version is 0/1\n  // see https://github.com/ethereum/go-ethereum/blob/v1.8.23/internal/ethapi/api.go#L465\n  let v = parseInt(signature.slice(130, 132), 16);\n  if (v < 27) {\n    v += 27;\n  }\n  const vHex = v.toString(16);\n  return signature.slice(0, 130) + vHex;\n}\n\nfunction makeApproveFunction(signFn, verbose) {\n  return async function(data) {\n    const signature = fixSignature(\n      await signFn(\n        soliditySha3(\n          { type: 'address', value: data.relayerAddress },\n          { type: 'address', value: data.from },\n          { type: 'bytes', value: data.encodedFunctionCall },\n          { type: 'uint256', value: toBN(data.txFee) },\n          { type: 'uint256', value: toBN(data.gasPrice) },\n          { type: 'uint256', value: toBN(data.gas) },\n          { type: 'uint256', value: toBN(data.nonce) },\n          { type: 'address', value: data.relayHubAddress },\n          { type: 'address', value: data.to },\n        ),\n      ),\n    );\n    if (verbose) console.log(`Signature for GSN transaction is ${signature}`);\n    return signature;\n  };\n}\n\nasync function createRelayHubFromRecipient(web3, recipientAddress) {\n  const relayRecipient = createRelayRecipient(web3, recipientAddress);\n  let relayHubAddress;\n  try {\n    relayHubAddress = await relayRecipient.methods.getHubAddr().call();\n  } catch (err) {\n    throw new Error(\n      `Could not get relay hub address from recipient at ${recipientAddress} (${err.message}). Make sure it is a valid recipient contract.`,\n    );\n  }\n\n  if (!relayHubAddress || ethUtils.isZeroAddress(relayHubAddress)) {\n    throw new Error(\n      `The relay hub address is set to zero in recipient at ${recipientAddress}. Make sure it is a valid recipient contract.`,\n    );\n  }\n\n  const code = await web3.eth.getCode(relayHubAddress);\n  if (code.length <= 2) {\n    throw new Error(`Relay hub is not deployed at address ${relayHubAddress}`);\n  }\n\n  const relayHub = createRelayHub(web3, relayHubAddress);\n  let hubVersion;\n  try {\n    hubVersion = await relayHub.methods.version().call();\n  } catch (err) {\n    throw new Error(\n      `Could not query relay hub version at ${relayHubAddress} (${err.message}). Make sure the address corresponds to a relay hub.`,\n    );\n  }\n\n  if (!hubVersion.startsWith('1')) {\n    throw new Error(`Unsupported relay hub version '${hubVersion}'.`);\n  }\n\n  return relayHub;\n}\n\nfunction createRelayRecipient(web3, addr) {\n  return new web3.eth.Contract(relayRecipientAbi, addr);\n}\n\nfunction createRelayHub(web3, addr) {\n  return new web3.eth.Contract(relayHubAbi, addr);\n}\n\nasync function isRelayHubDeployedForRecipient(web3, recipientAddr) {\n  try {\n    await createRelayHubFromRecipient(web3, recipientAddr);\n    return true;\n  } catch (_err) {\n    return false;\n  }\n}\n\nasync function getRecipientFunds(web3, recipientAddr) {\n  const relayHub = await createRelayHubFromRecipient(web3, recipientAddr);\n  return await relayHub.methods.balanceOf(recipientAddr).call();\n}\n\n// Gtxdatazero 4 Paid for every zero byte of data or code for a transaction.\n// Gtxdatanonzero 68 Paid for every non-zero byte of data or code for a transaction\n// From yellow paper https://gavwood.com/paper.pdf\n// May change soon (EIP 2028: Transaction data gas cost reduction) https://eips.ethereum.org/EIPS/eip-2028\nfunction getCallDataGas(data) {\n  if (typeof data !== 'string') throw new Error('Data has to be a string');\n  if (data.startsWith('0x')) data = data.slice(2);\n  let gasCost = 0;\n  for (let i = 0; i < data.length; i += 2) {\n    if (data.substr(i, 2) === '00') {\n      gasCost += 4;\n    } else {\n      gasCost += 68;\n    }\n  }\n  return gasCost;\n}\n\nmodule.exports = {\n  appendAddress,\n  callAsJsonRpc,\n  toInt,\n  preconditionCodeToDescription,\n  fixTransactionReceiptResponse,\n  getApprovalData,\n  fixSignature,\n  makeApproveFunction,\n  createRelayHubFromRecipient,\n  isRelayHubDeployedForRecipient,\n  getRecipientFunds,\n  getCallDataGas,\n  createRelayHub\n};\n"]},"metadata":{},"sourceType":"script"}